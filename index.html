import React, { useState, useEffect } from "react";
import { initializeApp } from "firebase/app";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  DocumentData,
} from "firebase/firestore";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL,
} from "firebase/storage";

// TODO: Thay thông tin Firebase của bạn vào đây
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
};

// Khởi tạo Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

interface Child {
  id: string;
  name: string;
  dob: string;
  avatarUrl: string;
}

export default function App() {
  const [children, setChildren] = useState<Child[]>([]);
  const [name, setName] = useState("");
  const [dob, setDob] = useState("");
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [loading, setLoading] = useState(false);

  // Load danh sách thiếu nhi
  const fetchChildren = async () => {
    const snapshot = await getDocs(collection(db, "children"));
    const data = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...(doc.data() as Omit<Child, "id">),
    }));
    setChildren(data);
  };

  useEffect(() => {
    fetchChildren();
  }, []);

  // Xử lý submit form
  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!name.trim() || !dob.trim()) {
      alert("Vui lòng nhập đầy đủ tên và ngày sinh");
      return;
    }

    setLoading(true);
    try {
      let avatarUrl = "";
      if (avatarFile) {
        const fileRef = ref(storage, `avatars/${Date.now()}-${avatarFile.name}`);
        await uploadBytes(fileRef, avatarFile);
        avatarUrl = await getDownloadURL(fileRef);
      }
      await addDoc(collection(db, "children"), {
        name: name.trim(),
        dob,
        avatarUrl,
      });
      setName("");
      setDob("");
      setAvatarFile(null);
      fetchChildren();
      alert("Thêm hồ sơ thành công!");
    } catch (err) {
      alert("Lỗi khi thêm hồ sơ");
    }
    setLoading(false);
  };

  return (
    <div style={{ maxWidth: 800, margin: "auto", padding: 20, fontFamily: "Arial" }}>
      <h1 style={{ textAlign: "center" }}>Quản lý thiếu nhi</h1>

      <form
        onSubmit={onSubmit}
        style={{
          backgroundColor: "#f9f9f9",
          padding: 20,
          borderRadius: 8,
          boxShadow: "0 2px 5px rgba(0,0,0,0.1)",
          marginBottom: 30,
        }}
      >
        <div style={{ marginBottom: 15 }}>
          <label>Tên thiếu nhi:</label><br />
          <input
            value={name}
            onChange={(e) => setName(e.target.value)}
            style={{ width: "100%", padding: 8, fontSize: 16 }}
            disabled={loading}
          />
        </div>

        <div style={{ marginBottom: 15 }}>
          <label>Ngày sinh:</label><br />
          <input
            type="date"
            value={dob}
            onChange={(e) => setDob(e.target.value)}
            style={{ width: "100%", padding: 8, fontSize: 16 }}
            disabled={loading}
          />
        </div>

        <div style={{ marginBottom: 15 }}>
          <label>Ảnh đại diện (tùy chọn):</label><br />
          <input
            type="file"
            accept="image/*"
            onChange={(e) =>
              e.target.files && e.target.files.length > 0
                ? setAvatarFile(e.target.files[0])
                : setAvatarFile(null)
            }
            disabled={loading}
          />
        </div>

        <button
          type="submit"
          disabled={loading}
          style={{
            width: "100%",
            padding: 12,
            fontSize: 18,
            backgroundColor: "#007bff",
            color: "white",
            border: "none",
            borderRadius: 6,
            cursor: loading ? "not-allowed" : "pointer",
          }}
        >
          {loading ? "Đang lưu..." : "Lưu hồ sơ"}
        </button>
      </form>

      <h2>Danh sách thiếu nhi</h2>
      {children.length === 0 && <p>Chưa có hồ sơ nào.</p>}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(auto-fill,minmax(200px,1fr))",
          gap: 20,
        }}
      >
        {children.map((child) => (
          <div
            key={child.id}
            style={{
              backgroundColor: "white",
              borderRadius: 8,
              padding: 15,
              boxShadow: "0 1px 3px rgba(0,0,0,0.1)",
              textAlign: "center",
            }}
          >
            {child.avatarUrl ? (
              <img
                src={child.avatarUrl}
                alt={child.name}
                style={{ width: 100, height: 100, borderRadius: "50%", objectFit: "cover" }}
              />
            ) : (
              <div
                style={{
                  width: 100,
                  height: 100,
                  borderRadius: "50%",
                  backgroundColor: "#ddd",
                  lineHeight: "100px",
                  color: "#666",
                  margin: "auto",
                }}
              >
                No Image
              </div>
            )}
            <h3 style={{ marginTop: 10 }}>{child.name}</h3>
            <p>Ngày sinh: {child.dob}</p>
          </div>
        ))}
      </div>
    </div>
  );
}
